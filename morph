#!/usr/bin/env bash
#===============================================================================
# 3D Face Morphing - CLI Entrypoint
#===============================================================================
#
# Clean shell wrapper for the face morphing pipeline.
# Automatically activates the conda environment and passes args to Python.
#
# Usage:
#   ./morph -i1 face1.fbx -i2 face2.fbx --gpu
#   ./morph --help
#
# Author: @costantinoai
#===============================================================================

set -euo pipefail

# Configuration
CONDA_ENV="face-morph"  # New environment name (use install.sh to create)
CONDA_ENV_FALLBACK="pytorch3d"  # Legacy environment name
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PYTHON_SCRIPT="$SCRIPT_DIR/run.py"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

#===============================================================================
# Helper Functions
#===============================================================================

print_error() {
    echo -e "${RED}ERROR:${NC} $1" >&2
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

check_conda() {
    if ! command -v conda &> /dev/null; then
        print_error "Conda not found. Please install Miniconda/Anaconda."
        echo "  Visit: https://docs.conda.io/en/latest/miniconda.html"
        exit 1
    fi
}

check_environment() {
    # Try new environment first
    if conda env list | grep -q "^${CONDA_ENV} "; then
        return 0
    fi

    # Fall back to legacy environment
    if conda env list | grep -q "^${CONDA_ENV_FALLBACK} "; then
        print_warning "Using legacy environment '${CONDA_ENV_FALLBACK}'"
        print_warning "Consider running './install.sh' to create optimized '${CONDA_ENV}' environment"
        CONDA_ENV="${CONDA_ENV_FALLBACK}"
        return 0
    fi

    # Neither environment found
    print_error "Conda environment '${CONDA_ENV}' not found."
    echo ""
    echo "Please run the installation script:"
    echo "  ${GREEN}./install.sh${NC}"
    echo ""
    echo "This will automatically:"
    echo "  - Detect your GPU (if available)"
    echo "  - Install PyTorch with correct CUDA support"
    echo "  - Build PyTorch3D from source with GPU rendering"
    echo "  - Install all dependencies"
    exit 1
}

show_banner() {
    cat << 'EOF'
╔══════════════════════════════════════════════════════════════════════╗
║                        3D FACE MORPHING                              ║
║                    GPU-Accelerated Pipeline                          ║
╚══════════════════════════════════════════════════════════════════════╝
EOF
}

#===============================================================================
# Argument Parsing
#===============================================================================

parse_args() {
    # Default values
    INPUT1=""
    INPUT2=""
    BATCH=""
    OUTPUT="results"
    RATIOS=""
    GPU_FLAG=""
    AMP_FLAG=""
    BLENDER=""
    VERBOSE_FLAG=""

    # Show help if no args
    if [[ $# -eq 0 ]]; then
        conda run -n "$CONDA_ENV" python "$PYTHON_SCRIPT" --help
        exit 0
    fi

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                conda run -n "$CONDA_ENV" python "$PYTHON_SCRIPT" --help
                exit 0
                ;;
            -i1|--input1)
                INPUT1="$2"
                shift 2
                ;;
            -i2|--input2)
                INPUT2="$2"
                shift 2
                ;;
            --batch)
                BATCH="$2"
                shift 2
                ;;
            -o|--output)
                OUTPUT="$2"
                shift 2
                ;;
            --ratios)
                RATIOS="$2"
                shift 2
                ;;
            --gpu)
                GPU_FLAG="--gpu"
                shift
                ;;
            --no-gpu)
                GPU_FLAG="--no-gpu"
                shift
                ;;
            --no-amp)
                AMP_FLAG="--no-amp"
                shift
                ;;
            --blender)
                BLENDER="$2"
                shift 2
                ;;
            -v|--verbose)
                VERBOSE_FLAG="--verbose"
                shift
                ;;
            -q|--quiet)
                VERBOSE_FLAG="--quiet"
                shift
                ;;
            *)
                print_error "Unknown argument: $1"
                echo "Use --help for usage information"
                exit 1
                ;;
        esac
    done

    # Build command
    CMD_ARGS=()

    [[ -n "$INPUT1" ]] && CMD_ARGS+=("--input1" "$INPUT1")
    [[ -n "$INPUT2" ]] && CMD_ARGS+=("--input2" "$INPUT2")
    [[ -n "$BATCH" ]] && CMD_ARGS+=("--batch" "$BATCH")
    [[ -n "$OUTPUT" ]] && CMD_ARGS+=("--output" "$OUTPUT")
    [[ -n "$RATIOS" ]] && CMD_ARGS+=("--ratios" "$RATIOS")
    [[ -n "$GPU_FLAG" ]] && CMD_ARGS+=("$GPU_FLAG")
    [[ -n "$AMP_FLAG" ]] && CMD_ARGS+=("$AMP_FLAG")
    [[ -n "$BLENDER" ]] && CMD_ARGS+=("--blender" "$BLENDER")
    [[ -n "$VERBOSE_FLAG" ]] && CMD_ARGS+=("$VERBOSE_FLAG")
}

#===============================================================================
# Main Execution
#===============================================================================

main() {
    # Check prerequisites
    check_conda
    check_environment

    # Parse arguments
    parse_args "$@"

    # Show banner
    show_banner
    echo ""

    # Run Python script with conda environment
    print_success "Activating environment: $CONDA_ENV"
    print_success "Running morphing pipeline..."
    echo ""

    if conda run -n "$CONDA_ENV" python "$PYTHON_SCRIPT" "${CMD_ARGS[@]}"; then
        echo ""
        print_success "Pipeline completed successfully!"
        exit 0
    else
        echo ""
        print_error "Pipeline failed. Check the error messages above."
        exit 1
    fi
}

# Run main
main "$@"
